
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <header name = "Access-Control-Allow-Origin" value = "*"> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de a√∫dio</title>
</head>
<body>
    <audio controls>
        <source src="./90sFlav - Call me.mp3">
    </audio>
    <canvas width="600" height="150"></canvas>

    <script type="module">
        var canvas = document.querySelector('canvas');
        var audio = document.querySelector('audio');
        var audioCtx = new AudioContext();
        var source = audioCtx.createMediaElementSource(audio);
        var analyser = audioCtx.createAnalyser();
        source.connect(analyser);
        source.connect(audioCtx.destination);

        // CORS
        audio.crossOrigin = "anonymous";

        analyser.fftSize = 1024;
        var bufferLength = analyser.fftSize;
        var dataArray = new Uint8Array(bufferLength);

        let contador = 0;
        let soma = 0;
        let media = 0;
        var w = canvas.width;
        var h = canvas.height;
        var sliceWidth = w * 1.0 / bufferLength;
        var canvasCtx = canvas.getContext('2d');
        canvasCtx.clearRect(0, 0, w, h);
        canvasCtx.fillStyle = 'rgb(200, 200, 200)';
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
            
        function draw() {
            
            requestAnimationFrame(draw);
            analyser.getByteTimeDomainData(dataArray);

            canvasCtx.fillRect(0, 0, w, h);
            canvasCtx.beginPath();

            var x = 0;
            let arranjoTeste = new Array;
            
            for(var i = 0; i < bufferLength; i++) {
                var v = dataArray[i] / 128.0;
                soma += v;
                var y = v * h/2;
                if(i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            if(contador % 60 === 0){
                media = soma / (bufferLength * 60);
                console.log(media);
                soma = 0;
                media = 0;
            }
            contador++;
            
            canvasCtx.lineTo(canvas.width, canvas.height/2);
            canvasCtx.stroke();
        };

        draw();
    </script>
</body>
</html>